{% extends "base.html" %} {% block title %}Line Tracking - SwiftRover{% endblock
%} {% block content %}
<div class="container">
  <h1 class="page-title">üìç Line Tracking</h1>

  <div class="card">
    <div class="card-header">
      <h2>üöó Autonomous Line Following</h2>
    </div>
    <div class="card-body">
      <p
        style="
          color: var(--text-secondary);
          margin-bottom: 2rem;
          font-size: 1.05rem;
        "
      >
        The robot automatically follows a black line using infrared sensors for
        detection and path correction.
      </p>

      <div
        style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1.5rem;
          margin-bottom: 2rem;
        "
      >
        <button
          class="btn btn-success"
          style="padding: 1rem 2rem; font-size: 1rem"
          id="start-btn"
          onclick="startLineTracking()"
        >
          ‚ñ∂Ô∏è START TRACKING
        </button>
        <button
          class="btn btn-danger"
          style="padding: 1rem 2rem; font-size: 1rem"
          id="stop-btn"
          onclick="stopLineTracking()"
          disabled
        >
          ‚èπÔ∏è STOP TRACKING
        </button>
      </div>

      <div
        class="status-message"
        id="status-message"
        style="margin-top: 2rem"
      ></div>
    </div>
  </div>

  <div class="card" style="margin-top: 2rem">
    <div class="card-header">
      <h2>üìä Line Sensor Status</h2>
    </div>
    <div class="card-body">
      <div
        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 2rem"
      >
        <div
          style="
            text-align: center;
            padding: 1.5rem;
            background: rgba(10, 125, 217, 0.05);
            border-radius: 12px;
          "
        >
          <div
            style="
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 0.5rem;
            "
          >
            Left IR
          </div>
          <div
            id="ir-left-status"
            style="font-size: 1.5rem; color: var(--accent-blue)"
          >
            --
          </div>
        </div>
        <div
          style="
            text-align: center;
            padding: 1.5rem;
            background: rgba(10, 125, 217, 0.05);
            border-radius: 12px;
          "
        >
          <div
            style="
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 0.5rem;
            "
          >
            Center IR
          </div>
          <div
            id="ir-center-status"
            style="font-size: 1.5rem; color: var(--accent-blue)"
          >
            --
          </div>
        </div>
        <div
          style="
            text-align: center;
            padding: 1.5rem;
            background: rgba(10, 125, 217, 0.05);
            border-radius: 12px;
          "
        >
          <div
            style="
              font-weight: 600;
              color: var(--text-primary);
              margin-bottom: 0.5rem;
            "
          >
            Right IR
          </div>
          <div
            id="ir-right-status"
            style="font-size: 1.5rem; color: var(--accent-blue)"
          >
            --
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top: 2rem">
    <div class="card-header">
      <h2>‚ÑπÔ∏è Information</h2>
    </div>
    <div class="card-body">
      <ul style="list-style: none; padding: 0">
        <li style="margin-bottom: 1rem; color: var(--text-secondary)">
          <span style="color: var(--accent-blue); font-weight: 600">‚Ä¢</span>
          Place robot on black line to start tracking
        </li>
        <li style="margin-bottom: 1rem; color: var(--text-secondary)">
          <span style="color: var(--accent-blue); font-weight: 600">‚Ä¢</span>
          Robot will automatically correct path using IR sensors
        </li>
        <li style="margin-bottom: 1rem; color: var(--text-secondary)">
          <span style="color: var(--accent-blue); font-weight: 600">‚Ä¢</span>
          Speed adjusts based on line position
        </li>
        <li style="color: var(--text-secondary)">
          <span style="color: var(--accent-blue); font-weight: 600">‚Ä¢</span>
          Press STOP to end autonomous operation
        </li>
      </ul>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  async function startLineTracking() {
    try {
      const response = await fetch("/api/line-tracking/start", {
        method: "POST",
      });
      const data = await response.json();
      if (data.success) {
        document.getElementById("start-btn").disabled = true;
        document.getElementById("stop-btn").disabled = false;
        showNotification("‚úì Line tracking started", "success");
      } else {
        showNotification("‚úó Failed to start line tracking", "error");
      }
    } catch (error) {
      showNotification("‚úó Connection error", "error");
    }
  }

  async function stopLineTracking() {
    const stopBtn = document.getElementById("stop-btn");
    const startBtn = document.getElementById("start-btn");

    // Disable button and show stopping message
    stopBtn.disabled = true;
    stopBtn.textContent = "‚è≥ STOPPING...";
    showNotification(
      "‚è≥ Sending stop command (may retry if rate limited)...",
      "info"
    );

    try {
      const response = await fetch("/api/line-tracking/stop", {
        method: "POST",
      });
      const data = await response.json();

      if (data.success) {
        startBtn.disabled = false;
        stopBtn.textContent = "‚èπÔ∏è STOP TRACKING";
        showNotification("‚úì Line tracking stopped", "success");
      } else if (data.rate_limited) {
        // Server is retrying - keep button disabled, wait longer
        showNotification("‚è≥ Rate limited - server is retrying...", "warning");
        stopBtn.textContent = "‚è≥ RETRYING...";
        // Re-enable after timeout since server handles retries
        setTimeout(() => {
          stopBtn.disabled = false;
          stopBtn.textContent = "‚èπÔ∏è STOP TRACKING";
        }, 3000);
      } else {
        stopBtn.disabled = false;
        stopBtn.textContent = "‚èπÔ∏è STOP TRACKING";
        showNotification("‚úó Failed to stop line tracking", "error");
      }
    } catch (error) {
      stopBtn.disabled = false;
      stopBtn.textContent = "‚èπÔ∏è STOP TRACKING";
      showNotification("‚úó Connection error", "error");
    }
  }

  // Update sensor status (reduced frequency to avoid rate limiting)
  async function updateSensorStatus() {
    try {
      const response = await fetch("/api/live-data");
      const data = await response.json();
      document.getElementById("ir-left-status").textContent =
        data.ir_left || "--";
      document.getElementById("ir-center-status").textContent =
        data.ir_center || "--";
      document.getElementById("ir-right-status").textContent =
        data.ir_right || "--";
    } catch (error) {
      console.error("Error updating sensor status:", error);
    }
  }

  updateSensorStatus();
  setInterval(updateSensorStatus, 2000); // Reduced from 1000ms to 2000ms to avoid rate limiting
</script>
{% endblock %}
