{% extends "base.html" %}
{% block title %}Sensors - SwiftRover{% endblock %}
{% block content %}
<div class="container">
  <h1 class="page-title">ğŸ“Š Sensor Analytics</h1>

  <div class="card">
    <div class="card-header">
      <h2>ğŸ“… Data Query</h2>
    </div>
    <div class="card-body">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: end;">
        <div>
          <label style="display: block; color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Select Date</label>
          <input type="date" id="date-input" style="padding: 0.7rem; background: rgba(10, 125, 217, 0.1); border: 1px solid var(--glass-border); border-radius: 8px; color: var(--text-primary); width: 100%; font-family: 'Inter', sans-serif;" />
        </div>
        <div>
          <button class="btn btn-primary" onclick="loadHistoricalData()" style="width: 100%;">
            ğŸ“ˆ Load Data
          </button>
        </div>
        <div>
          <button class="btn btn-secondary" onclick="loadAllData()" style="width: 100%; background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); border: 1px solid #0d47a1;">
            â¬‡ï¸ Load All
          </button>
        </div>
      </div>
    </div>
  </div>

  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem; margin-top: 2rem;">
    <div class="card">
      <div class="card-header">
        <h3>ğŸ“ Distance Measurements</h3>
      </div>
      <div class="card-body">
        <canvas id="ultrasonic-chart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>ğŸ“ Line Sensor Pattern</h3>
      </div>
      <div class="card-body">
        <canvas id="line-state-chart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>â—€ Left IR Sensor</h3>
      </div>
      <div class="card-body">
        <canvas id="ir-left-chart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>â— Center IR Sensor</h3>
      </div>
      <div class="card-body">
        <canvas id="ir-center-chart"></canvas>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h3>â–¶ Right IR Sensor</h3>
      </div>
      <div class="card-body">
        <canvas id="ir-right-chart"></canvas>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  let charts = {};

  function initCharts() {
    const chartConfigs = [
      { id: 'ultrasonic-chart', label: 'Distance (cm)', key: 'ultrasonic_cm' },
      { id: 'ir-left-chart', label: 'Left Sensor', key: 'ir_left' },
      { id: 'ir-center-chart', label: 'Center Sensor', key: 'ir_center' },
      { id: 'ir-right-chart', label: 'Right Sensor', key: 'ir_right' },
      { id: 'line-state-chart', label: 'Line State', key: 'line_state' },
    ];

    chartConfigs.forEach(config => {
      const ctx = document.getElementById(config.id);
      if (ctx) {
        charts[config.id] = createChart(ctx, 'line', {
          labels: [],
          datasets: [
            {
              label: config.label,
              data: [],
              borderColor: CHART_COLORS.primary,
              backgroundColor: CHART_COLORS.grid,
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: CHART_COLORS.primary,
              pointBorderColor: CHART_COLORS.text,
              pointRadius: 4,
              pointHoverRadius: 6,
            }
          ]
        });
      }
    });
  }

  async function loadHistoricalData() {
    const date = document.getElementById('date-input').value;
    if (!date) {
      showNotification('âœ— Please select a date', 'error');
      return;
    }

    try {
      const response = await fetch('/api/historical-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ date: date })
      });
      const data = await response.json();
      updateCharts(data);
      showNotification('âœ“ Data loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading historical data:', error);
      showNotification('âœ— Failed to load data', 'error');
    }
  }

  async function loadAllData() {
    try {
      const response = await fetch('/api/historical-data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      const data = await response.json();
      updateCharts(data);
      showNotification('âœ“ All data loaded successfully', 'success');
    } catch (error) {
      console.error('Error loading data:', error);
      showNotification('âœ— Failed to load data', 'error');
    }
  }

  function updateCharts(data) {
    if (!data || !data.timestamps || data.timestamps.length === 0) {
      console.warn('No data to display');
      return;
    }

    const formattedTimestamps = data.timestamps.map((ts) => {
      const d = new Date(ts);
      return d.toLocaleTimeString("en-US", {
        hour: "2-digit",
        minute: "2-digit",
      });
    });

    if (charts['ultrasonic-chart']) {
      charts['ultrasonic-chart'].data.labels = formattedTimestamps;
      charts['ultrasonic-chart'].data.datasets[0].data = data.ultrasonic || [];
      charts['ultrasonic-chart'].update();
    }

    if (charts['ir-left-chart']) {
      charts['ir-left-chart'].data.labels = formattedTimestamps;
      charts['ir-left-chart'].data.datasets[0].data = data.ir_left || [];
      charts['ir-left-chart'].update();
    }

    if (charts['ir-center-chart']) {
      charts['ir-center-chart'].data.labels = formattedTimestamps;
      charts['ir-center-chart'].data.datasets[0].data = data.ir_center || [];
      charts['ir-center-chart'].update();
    }

    if (charts['ir-right-chart']) {
      charts['ir-right-chart'].data.labels = formattedTimestamps;
      charts['ir-right-chart'].data.datasets[0].data = data.ir_right || [];
      charts['ir-right-chart'].update();
    }

    if (charts['line-state-chart']) {
      const lineStateMap = {
        '': 0, 'L': 1, 'M': 2, 'R': 3,
        'LM': 4, 'MR': 5, 'LR': 6, 'LMR': 7
      };
      charts['line-state-chart'].data.labels = formattedTimestamps;
      charts['line-state-chart'].data.datasets[0].data = (data.line_state || []).map(s => lineStateMap[s] || 0);
      charts['line-state-chart'].update();
    }
  }

  document.addEventListener('DOMContentLoaded', initCharts);
</script>
{% endblock %}
